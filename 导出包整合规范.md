# ACGStation 游戏文件同步器 - 导出包整合规范

## 概述

本文档定义了ACGStation游戏文件同步器的导出包格式和整合规范，用于标准化游戏文件的分发和同步机制。

## 导出包结构

### 1. 主导出包 (.zip)

```
GamePackage_v1.0.0.zip
├── manifest.json           # 导出清单文件
├── files/                  # 直接文件
│   ├── config.ini
│   ├── data.db
│   └── ...
├── folders/                # 解压的文件夹内容
│   ├── textures/
│   │   ├── ui/
│   │   └── models/
│   └── scripts/
├── update_packages/        # 压缩包更新
│   ├── assets.zip         # 标记为update_package的文件夹
│   ├── mods.zip
│   └── ...
└── archives/              # 常规压缩包
    ├── backup.zip
    └── ...
```

## 清单文件格式 (manifest.json)

### 1. 基本结构

```json
{
  "packageName": "GamePackage",
  "version": "1.0.0",
  "createdAt": "2024-01-01T00:00:00Z",
  "files": [
    {
      "name": "config.ini",
      "downloadUrl": "https://cdn.example.com/downloads/config.ini",
      "relativePath": "config.ini",
      "hash": "sha256_hash_here",
      "size": 1024,
      "type": "file",
      "autoExtract": null
    },
    {
      "name": "assets.zip",
      "downloadUrl": "https://cdn.example.com/downloads/assets.zip",
      "relativePath": "update_packages/assets.zip",
      "hash": "sha256_hash_here",
      "size": 10485760,
      "type": "update_package",
      "autoExtract": true
    },
    {
      "name": "backup.zip",
      "downloadUrl": "https://cdn.example.com/downloads/backup.zip",
      "relativePath": "archives/backup.zip",
      "hash": "sha256_hash_here",
      "size": 2097152,
      "type": "zip",
      "autoExtract": true
    }
  ]
}
```

### 2. 字段说明

#### 清单根字段
- `packageName`: 包名称，用于标识导出包
- `version`: 版本号，遵循语义化版本控制
- `createdAt`: 创建时间，ISO 8601格式
- `files`: 文件列表数组

#### 文件字段
- `name`: 文件名称
- `downloadUrl`: 下载URL，包含CDN前缀
- `relativePath`: 文件在导出包中的相对路径
- `hash`: SHA256哈希值，用于完整性验证
- `size`: 文件大小（字节）
- `type`: 文件类型，见下方类型定义
- `autoExtract`: 是否自动解压（仅适用于压缩文件）

## 文件类型定义

### 1. file
- **描述**: 普通文件
- **处理**: 直接下载到指定位置
- **autoExtract**: 始终为 `null`
- **用途**: 配置文件、数据文件、脚本等

### 2. zip
- **描述**: 常规压缩包
- **处理**: 下载后可选择性解压
- **autoExtract**: `true` 表示建议自动解压
- **用途**: 备份文件、可选组件等

### 3. update_package
- **描述**: 压缩包更新（减少服务器请求）
- **处理**: 下载后自动解压，用于批量更新
- **autoExtract**: 始终为 `true`
- **用途**: 大型资源包、模组包、纹理包等

## 导出流程

### 1. 文件选择阶段
```
用户选择文件/文件夹
    ↓
选择压缩选项
    ↓
选择是否为更新包 (仅压缩文件夹)
    ↓
设置导出参数 (包名、版本、CDN前缀)
```

### 2. 处理逻辑

#### 普通文件
```rust
type: "file"
autoExtract: null
处理: 直接添加到主ZIP
```

#### 文件夹 - 不压缩
```rust
type: "file" (每个子文件)
autoExtract: null
处理: 递归添加所有子文件到主ZIP
```

#### 文件夹 - 压缩 - 非更新包
```rust
type: "zip"
autoExtract: true
处理: 创建嵌套ZIP并添加到主ZIP
```

#### 文件夹 - 压缩 - 更新包
```rust
type: "update_package"
autoExtract: true
处理: 创建嵌套ZIP，优化为更新包
```

## 同步器行为规范

### 1. 下载优先级
1. **update_package**: 最高优先级，自动解压
2. **zip**: 中等优先级，可选解压
3. **file**: 基础优先级，直接使用

### 2. 完整性验证
- 所有文件必须通过SHA256哈希验证
- 验证失败的文件需要重新下载
- 支持断点续传机制

### 3. 解压规则
```typescript
if (file.type === "update_package") {
    // 强制自动解压到相对路径
    autoExtract = true;
    targetPath = getRelativePath(file.relativePath);
} else if (file.type === "zip" && file.autoExtract === true) {
    // 建议自动解压，用户可选择
    promptUserForExtraction(file);
} else {
    // 普通文件，直接保存
    saveFile(file);
}
```

## 服务器部署规范

### 1. 目录结构
```
/cdn/downloads/
├── packages/              # 完整导出包
│   ├── GamePackage_v1.0.0.zip
│   └── ...
├── files/                 # 解压后的单个文件
│   ├── config.ini
│   ├── data.db
│   └── ...
├── update_packages/       # 更新包
│   ├── assets.zip
│   ├── mods.zip
│   └── ...
└── archives/             # 常规压缩包
    ├── backup.zip
    └── ...
```

### 2. HTTP服务器要求
- 支持HTTP/1.1和HTTP/2
- 支持Range请求（断点续传）
- 提供ETag支持
- 启用GZIP压缩（文本文件）
- 设置适当的缓存策略

### 3. CDN配置
```nginx
# 示例Nginx配置
location /downloads/ {
    root /var/www/cdn;
    
    # 支持断点续传
    add_header Accept-Ranges bytes;
    
    # 缓存策略
    location ~* \.(zip|exe|bin)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
    
    location ~* \.(json|txt|ini)$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
}
```

## 版本管理

### 1. 版本号规范
- 遵循语义化版本控制 (Semantic Versioning)
- 格式: `MAJOR.MINOR.PATCH`
- 示例: `1.0.0`, `2.1.3`, `3.0.0-beta.1`

### 2. 向后兼容性
- `MAJOR`: 不兼容的API变更
- `MINOR`: 向后兼容的功能新增
- `PATCH`: 向后兼容的问题修正

### 3. 升级策略
```typescript
// 版本比较示例
function shouldUpdate(currentVersion: string, newVersion: string): boolean {
    return semver.gt(newVersion, currentVersion);
}

// 强制更新检查
function requiresForceUpdate(currentVersion: string, newVersion: string): boolean {
    return semver.major(newVersion) > semver.major(currentVersion);
}
```

## 安全考虑

### 1. 文件验证
- 所有文件必须提供SHA256哈希
- 下载前验证文件大小
- 解压前扫描恶意内容

### 2. 路径安全
```typescript
// 防止路径遍历攻击
function sanitizePath(filePath: string): string {
    return path.normalize(filePath).replace(/^(\.\.[\/\\])+/, '');
}
```

### 3. 权限控制
- 限制文件访问权限
- 验证用户下载权限
- 记录下载日志

## 错误处理

### 1. 常见错误代码
- `INVALID_HASH`: 文件哈希验证失败
- `DOWNLOAD_FAILED`: 网络下载失败
- `EXTRACT_FAILED`: 解压失败
- `PERMISSION_DENIED`: 权限不足
- `DISK_FULL`: 磁盘空间不足

### 2. 重试机制
```typescript
const retryConfig = {
    maxRetries: 3,
    backoffMultiplier: 2,
    initialDelay: 1000, // 1秒
    maxDelay: 30000,    // 30秒
};
```

## 性能优化

### 1. 并发下载
- 支持多文件并发下载
- 限制最大并发数（建议4-8个）
- 智能带宽分配

### 2. 压缩优化
- 更新包使用最佳压缩比
- 普通文件使用快速压缩
- 支持预压缩内容

### 3. 缓存策略
- 本地文件缓存
- HTTP缓存利用
- 增量更新支持

## 示例用法

### 1. 创建游戏更新包
```bash
# 选择游戏资源文件夹，标记为更新包
- 选择: /game/assets/
- 压缩: ✓
- 更新包: ✓
- 结果: assets.zip (type: "update_package")
```

### 2. 创建配置文件包
```bash
# 选择配置文件，不压缩
- 选择: /game/config.ini
- 压缩: ✗
- 结果: config.ini (type: "file")
```

### 3. 创建备份包
```bash
# 选择备份文件夹，普通压缩
- 选择: /game/saves/
- 压缩: ✓
- 更新包: ✗
- 结果: saves.zip (type: "zip")
```

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本规范定义
- 支持三种文件类型：file, zip, update_package
- 实现SHA256完整性验证
- 支持嵌套ZIP结构

---

**注意**: 本规范会随着功能迭代持续更新，请关注版本变更。
